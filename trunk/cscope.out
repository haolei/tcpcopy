cscope 15 $HOME/work/tcp/tcp_copy -q 0000000497 0000031609
	@config.h

5 
	#HAVE_ARPA_INET_H
 1

	)

8 
	#HAVE_ATEXIT
 1

	)

11 
	#HAVE_DLFCN_H
 1

	)

17 
	#HAVE_FCNTL_H
 1

	)

20 
	#HAVE_GETTIMEOFDAY
 1

	)

23 
	#HAVE_INET_NTOA
 1

	)

26 
	#HAVE_INTTYPES_H
 1

	)

29 
	#HAVE_LIMITS_H
 1

	)

33 
	#HAVE_MALLOC
 1

	)

36 
	#HAVE_MEMORY_H
 1

	)

42 
	#HAVE_NETINET_IN_H
 1

	)

48 
	#HAVE_SELECT
 1

	)

51 
	#HAVE_SOCKET
 1

	)

54 
	#HAVE_STDBOOL_H
 1

	)

57 
	#HAVE_STDINT_H
 1

	)

60 
	#HAVE_STDLIB_H
 1

	)

63 
	#HAVE_STRINGS_H
 1

	)

66 
	#HAVE_STRING_H
 1

	)

69 
	#HAVE_SYS_FILE_H
 1

	)

72 
	#HAVE_SYS_PARAM_H
 1

	)

75 
	#HAVE_SYS_SELECT_H
 1

	)

78 
	#HAVE_SYS_SOCKET_H
 1

	)

81 
	#HAVE_SYS_STAT_H
 1

	)

84 
	#HAVE_SYS_TIME_H
 1

	)

87 
	#HAVE_SYS_TYPES_H
 1

	)

90 
	#HAVE_UNISTD_H
 1

	)

96 
	#HAVE__BOOL
 1

	)

99 
	#PACKAGE
 "tıcİy"

	)

102 
	#PACKAGE_BUGREPORT
 "wªgbš579@gma.com"

	)

105 
	#PACKAGE_NAME
 "tıcİy"

	)

108 
	#PACKAGE_STRING
 "tıcİy 0.2"

	)

111 
	#PACKAGE_TARNAME
 "tıcİy"

	)

114 
	#PACKAGE_VERSION
 "0.2"

	)

117 
	#RETSIGTYPE
 

	)

120 
	#SELECT_TYPE_ARG1
 

	)

123 
	#SELECT_TYPE_ARG234
 (
fd_£t
 *)

	)

126 
	#SELECT_TYPE_ARG5
 (
timev®
 *)

	)

132 
	#TIME_WITH_SYS_TIME
 1

	)

135 
	#VERSION
 "0.2"

	)

138 cÚ¡

	)

142 #iâdeà
__ılu¥lus


157 vŞ©e

	)

	@src/communication/msg.c

1 
	~"msg.h
"

3 
	$tı_sock_š™
(){

4 
sock
;

5 if((
sock
 = 
	`sock‘
(
AF_INET
,
SOCK_STREAM
,0))<0){

6 
	`³¼Ü
("socket:");

7 
	`ex™
(
”ºo
);

9  
sock
;

10 
	}
}

12 
	$cÚÃù_to_£rv”
(
sock
,
ušt32_t
 

){

13 
sockaddr_š
 
»mÙe_addr
;

14 
	`mem£t
(&
»mÙe_addr
,0,(remote_addr));

15 
»mÙe_addr
.
sš_çmy
 = 
AF_INET
;

16 
»mÙe_addr
.
sš_addr
.
s_addr
 = 

;

17 
»mÙe_addr
.
sš_pÜt
 = 
	`htÚs
(
SERVER_PORT
);

18 if(
	`cÚÃù
(
sock
,(
sockaddr
 *)&
»mÙe_addr
,(remote_addr)) == -1){

19 
	`³¼Ü
("connecto„emote:");

20 
	`ex™
(
”ºo
);

22 
	}
}

24 
	$£t_sock_no_d–ay
(
sock
){

25 
æag
 = 1;

26 if(
	`£tsockİt
(
sock
,
IPPROTO_TCP
,
TCP_NODELAY
,(*)&
æag
,(flag)) == -1){

27 
	`³¼Ü
("setsockopt:");

28 
	`ex™
(
”ºo
);

30 
	}
}

32 
	$msg_cİy”_š™
(
ušt32_t
 
»ûiv”_
){

33 
sock
 = 
	`tı_sock_š™
();

34 
	`cÚÃù_to_£rv”
(
sock
,
»ûiv”_
);

35 
	`£t_sock_no_d–ay
(
sock
);

36  
sock
;

37 
	}
}

39 
	$sock_bšd
(
sock
){

40 
sockaddr_š
 
loÿl_addr
;

41 
	`mem£t
(&
loÿl_addr
,0,(local_addr));

42 
loÿl_addr
.
sš_pÜt
 = 
	`Áohs
(
SERVER_PORT
);

43 if(
	`bšd
(
sock
,(
sockaddr
 *)&
loÿl_addr
,(local_addr))==-1){

44 
	`³¼Ü
("canot bind:");

45 
	`ex™
(
”ºo
);

47 
	}
}

49 
	$sock_li¡’
(
sock
){

50 if(
	`li¡’
(
sock
,5)==-1){

51 
	`³¼Ü
("sock†isten:");

52 
	`ex™
(
”ºo
);

54 
	}
}

56 
	$msg_»ûiv”_š™
(){

57 
sock
 = 
	`tı_sock_š™
();

58 
	`sock_bšd
(
sock
);

59 
	`sock_li¡’
(
sock
);

60  
sock
;

61 
	}
}

63 
	$msg_cİy”_£nd
(
sock
,
ušt32_t
 
c_
,
ušt16_t
 
c_pÜt
,ušt16_ˆ
ty³
){

64 
cİy”_msg_¡
 
buf
;

65 
buf
.
ş›Á_
 = 
c_
;

66 
buf
.
ş›Á_pÜt
 = 
c_pÜt
;

67 
buf
.
ty³
 =ype;

68 
ssize_t
 
£ndËn
 = 
	`£nd
(
sock
,(cÚ¡ *)&
buf
,(buf),0);

69 if(
£ndËn
 !ğ(
buf
)){

72  
£ndËn
;

73 
	}
}

75 
»ûiv”_msg_¡
 
	gr_msg
;

77 
»ûiv”_msg_¡
 * 
	$msg_cİy”_»cv
(
sock
){

78 
size_t
 
Ën
 =0;

79 
Ën
 !ğ(
»ûiv”_msg_¡
)){

80 
ssize_t
 
»t
 = 
	`»cv
(
sock
,(*)&
r_msg
+
Ën
,(
»ûiv”_msg_¡
)-len,0);

81 if(
»t
 == 0){

82  
NULL
;

83 }if(
»t
 == -1){

86 
Ën
 +ğ
»t
;

89  &
r_msg
;

90 
	}
}

91 
cİy”_msg_¡
 
	gc_msg
;

92 
cİy”_msg_¡
 *
	$msg_»ûiv”_»cv
(
sock
){

93 
size_t
 
Ën
 = 0;

94 
Ën
 !ğ(
cİy”_msg_¡
)){

95 
ssize_t
 
»t
 = 
	`»cv
(
sock
,(*)&
c_msg
+
Ën
,(
cİy”_msg_¡
)-len,0);

96 if(
»t
 == 0){

97  
NULL
;

98 }if(
»t
 == -1){

101 
Ën
 +ğ
»t
;

104  &
c_msg
;

105 
	}
}

107 
	$msg_»ûiv”_£nd
(
sock
,
»ûiv”_msg_¡
 * 
msg
){

108 
ssize_t
 
£ndËn
 = 
	`£nd
(
sock
,(cÚ¡ *)
msg
,(
»ûiv”_msg_¡
),0);

109 if(
£ndËn
 !ğ(*
msg
)){

112  
£ndËn
;

113 
	}
}

	@src/communication/msg.h

17 #iâdeà 
_TCPCOPY_MSG_H__INC


18 
	#_TCPCOPY_MSG_H__INC


	)

20 #ifdeà
__ılu¥lus


25 
	~<¡dšt.h
>

26 
	~<sys/sock‘.h
>

27 
	~<Ãtš‘/tı.h
>

28 
	~<uni¡d.h
>

29 
	~<”ºo.h
>

30 
	~<¡dio.h
>

31 
	~<¡dlib.h
>

32 
	~<sys/ty³s.h
>

33 
	~<¬·/š‘.h
>

34 
	~<¡ršg.h
>

35 
	~<Ãtš‘/.h
>

36 
	#SERVER_PORT
 36524

	)

38 
	#CLIENT_ADD
 1

	)

39 
	#CLIENT_DEL
 2

	)

42 #´agm¨
·ck
(
push
,1)

43 
	scİy”_msg_¡
{

44 
ušt32_t
 
ş›Á_
;

45 
ušt16_t
 
ş›Á_pÜt
;

46 
ušt16_t
 
ty³
;

49 
	s»ûiv”_msg_¡
{

50 
hdr
 
_h—d”
;

51 
tıhdr
 
tı_h—d”
;

53 #´agm¨
·ck
(
pİ
)

55 
msg_cİy”_š™
(
ušt32_t
 
»ûiv”_
);

56 
msg_»ûiv”_š™
();

58 
msg_cİy”_£nd
(,
ušt32_t
,
ušt16_t
 ,uint16_t );

59 
»ûiv”_msg_¡
* 
msg_cİy”_»cv
(
sock
);

61 
msg_»ûiv”_£nd
(,
»ûiv”_msg_¡
 *);

62 
cİy”_msg_¡
* 
msg_»ûiv”_»cv
(
sock
);

64 #ifdeà
__ılu¥lus


	@src/event/select_server.c

1 
	~<¡dio.h
>

2 
	~<¡dšt.h
>

3 
	~<sys/ty³s.h
>

4 
	~<uni¡d.h
>

5 
	~<sys/£Ëù.h
>

7 
	~"£Ëù_£rv”.h
"

9 
	gmax_fd
;

10 
fd_£t
 
	g»ad_£t
;

11 
£Ëù_£rv”_func
 
	gÿÎback_func
;

12 
	gv®id_fds
[1024];

13 
	gfd_nums
;

15 
	$£Ëù_£v”_£t_ÿÎback
(
£Ëù_£rv”_func
 
func
){

16 
ÿÎback_func
 = 
func
;

17 
	}
}

19 
	$£Ëù_£v”_add
(
fd
){

20 
	`FD_SET
(
fd
,&
»ad_£t
);

21 if(
fd
 > 
max_fd
){

22 
max_fd
 = 
fd
;

24 
v®id_fds
[
fd_nums
] = 
fd
;

25 
fd_nums
++;

26 
	}
}

28 
	$£Ëù_£v”_d–
(
fd
){

29 
	`FD_CLR
(
fd
,&
»ad_£t
);

30 
max_fd
 = 0;

31 
i
 = 0;

32 
i
=0;i<
fd_nums
;i++){

33 if(
v®id_fds
[
i
] =ğ
fd
){

34 
j
=
i
;

35 
j
<
fd_nums
-1){

36 
v®id_fds
[
j
] = valid_fds[j+1];

37 if(
v®id_fds
[
j
] > 
max_fd
){

38 
max_fd
 = 
v®id_fds
[
j
];

41 
fd_nums
--;

44 if(
v®id_fds
[
i
] > 
max_fd
){

45 
max_fd
 = 
v®id_fds
[
i
];

48 
	}
}

50 
	$£Ëù_£rv”_run
(){

52 
fd_£t
 
r_£t
 = 
»ad_£t
;

53 
»t
 = 
	`£Ëù
(
max_fd
+1,&
r_£t
,
NULL
,NULL,NULL);

54 if(
»t
 == -1){

56 }if(
»t
 == 0){

59 
i
 = 0;

60 
i
=0;i<
fd_nums
;i++){

61 if(
	`FD_ISSET
(
v®id_fds
[
i
],&
r_£t
)){

62 
	`ÿÎback_func
(
v®id_fds
[
i
]);

67 
	}
}

	@src/event/select_server.h

17 #iâdeà 
_TCPCOPY_SELECT_SERVER_H__INC


18 
	#_TCPCOPY_SELECT_SERVER_H__INC


	)

20 #ifdeà
__ılu¥lus


25 (*
£Ëù_£rv”_func
)(
	tfd
);

27 
£Ëù_£v”_£t_ÿÎback
(
£Ëù_£rv”_func
 
func
);

28 
£Ëù_£v”_add
();

29 
£Ëù_£v”_d–
();

31 
£Ëù_£rv”_run
();

33 #ifdeà
__ılu¥lus


	@src/interception/delay.c

17 
	~"hash.h
"

18 
	~"d–ay.h
"

20 
hash_bË
 *
	gbË
;

22 
	$d–ay_bË_š™
(){

23 
bË
 = 
	`hash_ü—‹
(65536);

24 
	`hash_£t_timeout
(
bË
,10);

25 
	}
}

27 
»ûiv”_msg_¡
 * 
	$cİy_mes§ge
(
»ûiv”_msg_¡
 *
msg
){

28 
»ûiv”_msg_¡
 *
cmsg
 = (»ûiv”_msg_¡ *)
	`m®loc
((receiver_msg_st));

29 if(
cmsg
 =ğ
NULL
){

30 
	`³¼Ü
("malloc");

31 
	`ex™
(1);

33 
	`memıy
(
cmsg
,
msg
,(
»ûiv”_msg_¡
));

34  
cmsg
;

35 
	}
}

37 
	$d–ay_bË_add
(
ušt64_t
 
key
,
»ûiv”_msg_¡
 *
msg
){

38 
lškli¡
 *
msg_li¡
 =Öškli¡ *)
	`hash_fšd
(
bË
,
key
);

39 
»ûiv”_msg_¡
 *
cmsg
 = 
	`cİy_mes§ge
(
msg
);

40 
Êod•Œ
 
²ode
 = 
	`Êode_m®loc
((*)
cmsg
);

41 if(
msg_li¡
 =ğ
NULL
){

42 
msg_li¡
 = 
	`lškli¡_ü—‹
();

43 
	`hash_add
(
bË
,
key
,
msg_li¡
);

45 
	`lškli¡_­³nd
(
msg_li¡
,
²ode
);

47 
	}
}

49 
	$d–ay_bË_£nd
(
ušt64_t
 
key
,
fd
){

50 
lškli¡
 *
msg_li¡
 =Öškli¡ *)
	`hash_fšd
(
bË
,
key
);

51 if(
msg_li¡
 =ğ
NULL
){

54 ! 
	`lškli¡_is_em±y
(
msg_li¡
)){

55 
Êod•Œ
 
fœ¡
 = 
	`lškli¡_pİ_fœ¡
(
msg_li¡
);

56 
»ûiv”_msg_¡
 *
msg
 = (
fœ¡
->
d©a
);

57 
	`msg_»ûiv”_£nd
(
fd
,
msg
);

58 
	`ä“
(
msg
);

59 
	`Êode_ä“
(
fœ¡
);

61 
	}
}

	@src/interception/delay.h

18 #iâdeà 
_TCPCOPY_RECEIVER_DELAY_H__INC


19 
	#_TCPCOPY_RECEIVER_DELAY_H__INC


	)

21 #ifdeà
__ılu¥lus


26 
	~"../communiÿtiÚ/msg.h
"

28 
d–ay_bË_š™
();

29 
d–ay_bË_add
(
ušt64_t
 
key
,
»ûiv”_msg_¡
 *);

30 
d–ay_bË_£nd
(
ušt64_t
 
key
,
fd
);

32 #ifdeà
__ılu¥lus


	@src/interception/hash.c

17 
	~"hash.h
"

19 
hash_node
 *
	$hash_node_m®loc
(
ušt64_t
 
key
,*
d©a
){

20 
hash_node
 * 
Ãwnode
 = (hash_nod*)
	`m®loc
((hash_node));

21 if(! 
Ãwnode
){

22 
	`³¼Ü
("cannot malloc memory!");

23 
	`ex™
(
”ºo
);

25 
Ãwnode
->
key
 = key;

26 
Ãwnode
->
d©a
 = data;

27 
Ãwnode
->
acûss_time
 = 
	`time
(
NULL
);

28  
Ãwnode
;

29 
	}
}

30 
šlše
 
size_t
 
	$g‘_¦Ù
(
ušt64_t
 
key
,
size_t
 
size
){

31  
key
%
size
;

32 
	}
}

34 
hash_bË
 *
	$hash_ü—‹
(
size_t
 
size
){

35 
hash_bË
 * 
hbË
 = (hash_bË *)
	`m®loc
((hash_table));

36 if(! 
hbË
){

37 
	`³¼Ü
("cannot malloc memory!");

38 
	`ex™
(
”ºo
);

40 
hbË
->
size
 = size;

41 
hbË
->
li¡s
 = (
lškli¡
 **è
	`m®loc
(Öškli¡ *è*
size
);

42 if(! 
hbË
->
li¡s
){

43 
	`³¼Ü
("cannot malloc memory!");

44 
	`ex™
(
”ºo
);

46 
size_t
 
i
 =0;

47 
i
=0;i<
size
;i++){

48 
hbË
->
li¡s
[
i
] = 
	`lškli¡_ü—‹
();

50 
hbË
->
timeout
 = 
DEFAULT_TIMEOUT
;

51  
hbË
;

52 
	}
}

54 
	$d–‘e_timeout
(
hash_bË
 *
bË
,
lškli¡
 *
l
){

55 
time_t
 
nowtime
 = 
	`time
(
NULL
);

57 
Êod•Œ
 
node
 = 
	`lškli¡_
(
l
);

58 if(! 
node
 ){

61 
hash_node
 *
hnode
 = (hash_nod*)
node
->
d©a
;

62 if(
hnode
->
acûss_time
+
bË
->
timeout
 < 
nowtime
){

63 
	`lškli¡_pİ_
(
l
);

68 
	}
}

69 
šlše
 
lškli¡
 * 
	$g‘_lškli¡
(
hash_bË
 *
bË
,
ušt64_t
 
key
){

70 
size_t
 
¦Ù
 = 
	`g‘_¦Ù
(
key
,
bË
->
size
);

71 
lškli¡
 *
l
 = 
bË
->
li¡s
[
¦Ù
];

72  
l
;

73 
	}
}

75 
Êod•Œ
 
	$hash_fšd_node
(
hash_bË
 *
bË
,
ušt64_t
 
key
){

76 
lškli¡
 *
l
 = 
	`g‘_lškli¡
(
bË
,
key
);

77 
	`d–‘e_timeout
(
bË
,
l
);

78 
Êod•Œ
 
node
 = 
	`lškli¡_fœ¡
(
l
);

79 
node
){

80 
hash_node
 *
hnode
 = (hash_nod*)
node
->
d©a
;

81 if(
hnode
->
key
 == key){

82 
hnode
->
acûss_time
 = 
	`time
(
NULL
);

83 
	`lškli¡_»move
(
node
);

84 
	`lškli¡_push
(
l
,
node
);

85  
node
;

87 
node
 = 
	`lškli¡_g‘_Ãxt
(
l
,node);

89  
NULL
;

90 
	}
}

92 * 
	$hash_fšd
(
hash_bË
 *
bË
,
ušt64_t
 
key
){

93 
Êod•Œ
 
node
 = 
	`hash_fšd_node
(
bË
,
key
);

94 if(
node
 !ğ
NULL
){

95 
hash_node
 *
hnode
 = (hash_nod*è
node
->
d©a
;

96  
hnode
->
d©a
;

98  
NULL
;

99 
	}
}

101 
	$hash_add
(
hash_bË
 *
bË
,
ušt64_t
 
key
,*
d©a
){

102 
Êod•Œ
 
node
 = 
	`hash_fšd_node
(
bË
,
key
);

103 if(
node
 !ğ
NULL
){

104 
hash_node
 *
hnode
 = (hash_nod*è
node
->
d©a
;

105 
hnode
->
d©a
 = data;

108 
hash_node
 *
Ãwnode
 = 
	`hash_node_m®loc
(
key
,
d©a
);

109 
Êod•Œ
 
²ode
 = 
	`Êode_m®loc
(
Ãwnode
);

110 
lškli¡
 *
l
 = 
	`g‘_lškli¡
(
bË
,
key
);

111 
	`lškli¡_push
(
l
,
²ode
);

113 
	}
}

116 
	$hash_d–
(
hash_bË
 *
bË
,
ušt64_t
 
key
){

117 
Êod•Œ
 
node
 = 
	`hash_fšd_node
(
bË
,
key
);

118 if(
node
 !ğ
NULL
){

119 
	`lškli¡_»move
(
node
);

120 
	`Êode_ä“
(
node
);

123 
	}
}

125 
	$hash_£t_timeout
(
hash_bË
 *
bË
,
t
){

126 
bË
->
timeout
 = 
t
;

127 
	}
}

	@src/interception/hash.h

17 #iâdeà 
_TCPCOPY_HASH_H__INC


18 
	#_TCPCOPY_HASH_H__INC


	)

20 #ifdeà
__ılu¥lus


25 
	~<¡dio.h
>

26 
	~<sys/ty³s.h
>

27 
	~<uni¡d.h
>

28 
	~<sigÇl.h
>

29 
	~<sys/·¿m.h
>

30 
	~<sys/¡©.h
>

31 
	~<time.h
>

32 
	~<¡dlib.h
>

33 
	~<”ºo.h
>

34 
	~<sys/fe.h
>

35 
	~<¡ršg.h
>

36 
	~<¡dio.h
>

37 
	~<¡dšt.h
>

39 
	~"lškli¡.h
"

41 
	#DEFAULT_TIMEOUT
 1200

	)

43 
	shash_node_¡
{

44 
ušt64_t
 
key
;

45 
time_t
 
acûss_time
;

46 *
d©a
;

47 }
	thash_node
;

49 
	shash_bË_¡
{

50 
ušt32_t
 
size
;

51 
timeout
;

52 
lškli¡
 **
li¡s
;

53 }
	thash_bË
;

55 
hash_bË
 * 
hash_ü—‹
(
size_t
 
size
);

56 
hash_£t_timeout
(
hash_bË
 *,);

57 
hash_de¡Üy
(
hash_bË
 *);

58 
hash_add
(
hash_bË
 *,
ušt64_t
 ,*);

59 *
hash_fšd
(
hash_bË
 *,
ušt64_t
);

60 
hash_d–
(
hash_bË
 *,
ušt64_t
);

62 #ifdeà
__ılu¥lus


	@src/interception/interception.c

1 
	~"../communiÿtiÚ/msg.h
"

2 
	~"../ev’t/£Ëù_£rv”.h
"

3 
	~"Æ_fœew®l.h
"

4 
	~"š‹rû±iÚ.h
"

5 
	~"¡©us.h
"

6 
	~"d–ay.h
"

8 
	gfœew®l_sock
;

9 
	gmsg_li¡’_sock
;

11 
	$£t_sock_no_d–ay
(
sock
){

12 
æag
 = 1;

13 if(
	`£tsockİt
(
sock
,
IPPROTO_TCP
,
TCP_NODELAY
,(*)&
æag
,(flag)) == -1){

14 
	`³¼Ü
("setsockopt:");

15 
	`ex™
(
”ºo
);

17 
	}
}

19 
	$fÜm©Ouut
(
hdr
 *
_h—d”
)

21 
š_addr
 
¤ÿddr
;

22 
š_addr
 
de¡addr
;

23 
¤ÿddr
.
s_addr
=
_h—d”
->
§ddr
;

24 
de¡addr
.
s_addr
=
_h—d”
->
daddr
;

25 * 
tmpbuf
=
	`š‘_Áß
(
¤ÿddr
);

26 
sbuf
[1024];

27 
	`mem£t
(
sbuf
,0,1024);

28 
	`¡rıy
(
sbuf
,
tmpbuf
);

29 
dbuf
[1024];

30 
	`mem£t
(
dbuf
,0,1024);

31 
tmpbuf
=
	`š‘_Áß
(
de¡addr
);

32 
	`¡rıy
(
dbuf
,
tmpbuf
);

33 
size_t
 
size_
 = 
_h—d”
->
ihl
<<2;

34 
tıhdr
 *
tı_h—d”
ğ(tıhdr*)((*)
_h—d”
+
size_
);

35 
ušt32_t
 
·ckSize
=
	`Áohs
(
_h—d”
->
tÙ_Ën
);

36 
£q
=
	`Áohl
(
tı_h—d”
->seq);

37 
ack_£q
=
	`Áohl
(
tı_h—d”
->ack_seq);

39 
	`´štf
("from backend server: %s:%u-->%s:%u,length %u,seq=%u,ack_seq=%u\n",

40 
sbuf
,
	`Áohs
(
tı_h—d”
->
sourû
),
dbuf
,ÁohsÑı_h—d”->
de¡
),
·ckSize
,
£q
,
ack_£q
);

43 
	}
}

46 
	g£q
 =0;

47 
	gdrİ_bufãr
[128];

48 
	$drİ_Ãšk_·ck‘
(
·ck‘_id
)

50 
Æmsghdr
* 
Æ_h—d”
=(Æmsghdr*)
drİ_bufãr
;

51 
Æ_h—d”
->
Æmsg_ty³
=
IPQM_VERDICT
;

52 
Æ_h—d”
->
Æmsg_Ën
=
	`NLMSG_LENGTH
((
q_v”diù_msg
));

53 
Æ_h—d”
->
Æmsg_æags
=(
NLM_F_REQUEST
);

54 
Æ_h—d”
->
Æmsg_pid
=
	`g‘pid
();

55 
Æ_h—d”
->
Æmsg_£q
=
£q
++;

56 
q_v”diù_msg
 *
v”_d©a
 = 
NULL
;

57 
v”_d©a
=(
q_v”diù_msg
 *)
	`NLMSG_DATA
(
Æ_h—d”
);

58 
v”_d©a
->
v®ue
=
NF_DROP
;

59 
v”_d©a
->
id
=
·ck‘_id
;

60 
sockaddr_Æ
 
addr
;

61 
	`mem£t
(&
addr
,0,(addr));

62 
addr
.
Æ_çmy
 = 
AF_NETLINK
;

63 
addr
.
Æ_pid
 = 0;

64 
addr
.
Æ_groups
 = 0;

65 if(
	`£ndto
(
fœew®l_sock
,(*)
Æ_h—d”
,Æ_h—d”->
Æmsg_Ën
,0,

66 (
sockaddr
 *)&
addr
,(
sockaddr_Æ
))<0)

68 
	`³¼Ü
("unableo send mode message");

69 
	`ex™
(0);

72 
	}
}

73 
	g»cvFromTe¡
=0;

74 
	$š‹rû±iÚ_´oûss
(
fd
){

75 if(
fd
 =ğ
msg_li¡’_sock
){

76 
Ãwfd
 = 
	`acû±
(
msg_li¡’_sock
,
NULL
,NULL);

77 
	`£t_sock_no_d–ay
(
Ãwfd
);

78 if(
Ãwfd
 != -1){

79 
	`£Ëù_£v”_add
(
Ãwfd
);

81 }if(
fd
 =ğ
fœew®l_sock
){

82 
·ck‘_id
=0;

83 
hdr
 *
_h—d”
 = 
	`Æ_fœew®l_»cv
(
fœew®l_sock
,&
·ck‘_id
);

84 
	`¡©us_upd©e
(
_h—d”
);

85 
»cvFromTe¡
++;

87 
	`fÜm©Ouut
(
_h—d”
);

90 
	`drİ_Ãšk_·ck‘
(
·ck‘_id
);

92 
cİy”_msg_¡
 *
c_msg
 = 
	`msg_»ûiv”_»cv
(
fd
);

93 if(
c_msg
){

94 if(
c_msg
->
ty³
 =ğ
CLIENT_ADD
){

95 
	`¡©us_add
(
c_msg
->
ş›Á_
,c_msg->
ş›Á_pÜt
,
fd
);

96 }if(
c_msg
->
ty³
 =ğ
CLIENT_DEL
){

97 
	`¡©us_d–
(
c_msg
->
ş›Á_
,c_msg->
ş›Á_pÜt
);

100 
	`şo£
(
fd
);

101 
	`£Ëù_£v”_d–
(
fd
);

104 
	}
}

106 
	$š‹rû±iÚ_š™
(){

107 
	`d–ay_bË_š™
();

108 
	`¡©us_š™
();

109 
	`£Ëù_£v”_£t_ÿÎback
(
š‹rû±iÚ_´oûss
);

110 
msg_li¡’_sock
 = 
	`msg_»ûiv”_š™
();

111 
	`£Ëù_£v”_add
(
msg_li¡’_sock
);

112 
fœew®l_sock
 = 
	`Æ_fœew®l_š™
();

113 
	`£Ëù_£v”_add
(
fœew®l_sock
);

114 
	}
}

116 
	$š‹rû±iÚ_run
(){

117 
	`£Ëù_£rv”_run
();

118 
	}
}

120 
	$š‹rû±iÚ_ov”
(){

121 if(
fœew®l_sock
!=-1)

123 
	`şo£
(
fœew®l_sock
);

126 if(
msg_li¡’_sock
!=-1)

128 
	`şo£
(
msg_li¡’_sock
);

130 
	`ex™
(0);

131 
	}
}

	@src/interception/interception.h

18 #iâdeà 
_TCPCOPY_SERVER_H__INC


19 
	#_TCPCOPY_SERVER_H__INC


	)

21 #ifdeà
__ılu¥lus


26 
	~<¡dšt.h
>

28 
š‹rû±iÚ_š™
();

29 
š‹rû±iÚ_run
();

30 
š‹rû±iÚ_ov”
();

31 #ifdeà
__ılu¥lus


	@src/interception/linklist.c

17 
	~<¡dio.h
>

18 
	~<sys/ty³s.h
>

19 
	~<uni¡d.h
>

20 
	~<sigÇl.h
>

21 
	~<sys/·¿m.h
>

22 
	~<sys/¡©.h
>

23 
	~<time.h
>

24 
	~<¡dlib.h
>

25 
	~<”ºo.h
>

26 
	~<sys/fe.h
>

27 
	~<¡ršg.h
>

28 
	~<¡dio.h
>

29 
	~<¡dšt.h
>

31 
	~"lškli¡.h
"

33 
Êod•Œ
 
	$Êode_m®loc
(*
d©a
){

34 
Êod•Œ
 
p
;

35 if((
p
 = (
Êod•Œ
)
	`m®loc
((
lšknode
))è=ğ
NULL
){

36  
NULL
;

38 
p
->
d©a
 = data;

39 
p
->
Ãxt
 = 
NULL
;

40 
p
->
´ev
 = 
NULL
;

41  
p
;

42 
	}
}

44 
	$Êode_ä“
(
Êod•Œ
 
p
){

45 
	`ä“
(
p
);

46 
	}
}

48 
lškli¡
 * 
	$lškli¡_ü—‹
(){

49 
lškli¡
 *
l
ğÖškli¡ *)
	`m®loc
((linklist ));

50 if(! 
l
){

51 
	`³¼Ü
("malloc");

52  
NULL
;

54 
l
->
h—d
.
Ãxt
 = &†->head;

55 
l
->
h—d
.
´ev
 = &†->head;

56  
l
;

57 
	}
}

59 
	$lškli¡_ş—r
(
lškli¡
 *
l
){

60 
Êod•Œ
 
p
 = 
l
->
h—d
.
Ãxt
;

61 
Êod•Œ
 
²ext
;

62 
p
 !=& 
l
->
h—d
){

63 
²ext
 = 
p
->
Ãxt
;

64 
	`Êode_ä“
(
p
);

65 
p
 = 
²ext
;

67 
	}
}

69 
	$lškli¡_de¡Üy
(
lškli¡
 *
l
){

70 
	`lškli¡_ş—r
(
l
);

71 
	`ä“
(
l
);

72 
	}
}

74 
	$lškli¡_­³nd
(
lškli¡
 *
l
,
Êod•Œ
 
p
){

75 
Êod•Œ
 
node
 =
l
->
h—d
.
´ev
;

76 
node
->
Ãxt
 = 
p
;

77 
p
->
´ev
 = 
node
;

78 
l
->
h—d
.
´ev
 = 
p
;

79 
p
->
Ãxt
 =& 
l
->
h—d
;

80 
	}
}

82 
	$lškli¡_push
(
lškli¡
 *
l
,
Êod•Œ
 
p
){

83 
Êod•Œ
 
node
 =
l
->
h—d
.
Ãxt
;

84 
node
->
´ev
 = 
p
;

85 
p
->
Ãxt
 = 
node
;

86 
l
->
h—d
.
Ãxt
 = 
p
;

87 
p
->
´ev
 = & 
l
->
h—d
;

89 
	}
}

92 
Êod•Œ
 
	$lškli¡_»move
(
Êod•Œ
 
node
){

93 
Êod•Œ
 
²ext
 = 
node
->
Ãxt
;

94 
Êod•Œ
 
µ»v
 = 
node
->
´ev
;

95 
²ext
->
´ev
 = 
µ»v
;

96 
µ»v
->
Ãxt
 = 
²ext
;

97  
node
;

98 
	}
}

100 
Êod•Œ
 
	$lškli¡_fœ¡
(
lškli¡
 *
l
){

101 if(
l
->
h—d
.
Ãxt
 ==&†->head){

102  
NULL
;

104  
l
->
h—d
.
Ãxt
;

105 
	}
}

106 
Êod•Œ
 
	$lškli¡_
(
lškli¡
 *
l
){

107 if(
l
->
h—d
.
Ãxt
 ==&†->head){

108  
NULL
;

110  
l
->
h—d
.
´ev
;

111 
	}
}

113 
Êod•Œ
 
	$lškli¡_pİ_fœ¡
(
lškli¡
 *
l
){

114 
Êod•Œ
 
fœ¡
 = 
	`lškli¡_fœ¡
(
l
);

115 if(! 
fœ¡
){

116  
fœ¡
;

118  
	`lškli¡_»move
(
fœ¡
);

119 
	}
}

121 
Êod•Œ
 
	$lškli¡_pİ_
(
lškli¡
 *
l
){

122 
Êod•Œ
 

 = 
	`lškli¡_
(
l
);

123 if(! 

){

124  

;

126  
	`lškli¡_»move
(

);

127 
	}
}

129 
Êod•Œ
 
	$lškli¡_g‘_Ãxt
(
lškli¡
 *
l
,
Êod•Œ
 
p
){

130 if(
p
->
Ãxt
 =ğ& 
l
->
h—d
){

131  
NULL
;

133  
p
->
Ãxt
;

134 
	}
}

136 
	$lškli¡_is_em±y
(
lškli¡
 *
l
){

137 if(
l
->
h—d
.
Ãxt
 == &†->head){

141 
	}
}

	@src/interception/linklist.h

18 #iâdeà 
_LINKLIST_H__INC


19 
	#_LINKLIST_H__INC


	)

21 #ifdeà
__ılu¥lus


26 
	slšknode


28 *
d©a
;

29 
lšknode
 *
´ev
;

30 
lšknode
 *
Ãxt
;

31 }
	tlšknode
,*
	tÊod•Œ
;

33 
	slškli¡
{

34 
lšknode
 
h—d
;

35 }
	tlškli¡
;

38 
Êod•Œ
 
Êode_m®loc
(*
d©a
);

39 
Êode_ä“
(
Êod•Œ
 
p
);

41 
lškli¡
 * 
lškli¡_ü—‹
();

42 
lškli¡_de¡Üy
(
lškli¡
 *
l
);

43 
lškli¡_­³nd
(
lškli¡
 *
l
,
Êod•Œ
 );

44 
lškli¡_push
(
lškli¡
 *
l
,
Êod•Œ
 
p
);

45 
Êod•Œ
 
lškli¡_»move
Önod•Œ 
node
);

46 
Êod•Œ
 
lškli¡_fœ¡
(
lškli¡
 *
l
);

47 
Êod•Œ
 
lškli¡_
(
lškli¡
 *
l
);

48 
Êod•Œ
 
lškli¡_pİ_fœ¡
(
lškli¡
 *
l
);

49 
Êod•Œ
 
lškli¡_pİ_
(
lškli¡
 *
l
);

50 
Êod•Œ
 
lškli¡_g‘_Ãxt
(
lškli¡
 *
l
,Êod•Œ 
p
);

51 
lškli¡_is_em±y
(
lškli¡
 *
l
);

53 #ifdeà
__ılu¥lus


	@src/interception/main.c

1 #ifdeà
HAVE_CONFIG_H


2 
	~<cÚfig.h
>

5 
	~<uni¡d.h
>

6 
	~<g‘İt.h
>

7 
	~<¡dio.h
>

8 
	~<¡dlib.h
>

9 
	~<libg’.h
>

10 
	~<”ºo.h
>

11 
	~<¡ršg.h
>

12 
	~<sigÇl.h
>

14 
	~"š‹rû±iÚ.h
"

16 
	$sigÇl_hªdËr
(
sig
)

18 
	`´štf
("%d\n",
sig
);

19 
	`š‹rû±iÚ_ov”
();

20 
	}
}

22 
	$£t_sigÇl_hªdËr
(){

23 
	`©ex™
(
š‹rû±iÚ_ov”
);

24 
	`sigÇl
(
SIGINT
,
sigÇl_hªdËr
);

25 
	`sigÇl
(
SIGPIPE
,
sigÇl_hªdËr
);

26 
	`sigÇl
(
SIGHUP
,
sigÇl_hªdËr
);

27 
	`sigÇl
(
SIGTERM
,
sigÇl_hªdËr
);

28 
	}
}

30 
	$maš
(){

31 
	`£t_sigÇl_hªdËr
();

32 
	`š‹rû±iÚ_š™
();

33 
	`š‹rû±iÚ_run
();

35 
	}
}

	@src/interception/nl.c

17 
	~"Æ.h
"

19 
	$sock_š™
(
´ÙocŞ
){

20 
sock
 = 
	`sock‘
(
AF_NETLINK
,
SOCK_RAW
,
´ÙocŞ
);

21 if(
sock
 == -1){

22 
	`³¼Ü
("socket:");

23 
	`ex™
(
”ºo
);

25  
sock
;

26 
	}
}

28 
	$sock_bšd
(
sock
,
groups
){

29 
sockaddr_Æ
 
addr
;

30 
	`mem£t
(&
addr
,0,(addr));

31 
addr
.
Æ_çmy
 = 
AF_NETLINK
;

32 
addr
.
Æ_pid
 = 
	`g‘pid
();

33 
addr
.
Æ_groups
 = 
groups
;

34 if(
	`bšd
(
sock
,(
sockaddr
 *)&
addr
, (addr)) < 0){

35 
	`³¼Ü
("bind:");

36 
	`ex™
(
”ºo
);

38 
	}
}

40 
	$Æ_š™
(
´ÙocŞ
,
groups
){

41 
sock
 = 
	`sock_š™
(
´ÙocŞ
);

42 
	`sock_bšd
(
sock
,
groups
);

43 
rcvbuf
 = 1024*1024;

44 
	`£tsockİt
(
sock
,
SOL_SOCKET
,
SO_RCVBUF
,&
rcvbuf
,(rcvbuf));

45  
sock
;

46 
	}
}

48 
	$Æ_£t_mode
(
sock
,
ušt8_t
 
mode
,
size_t
 
¿nge
){

50 
Æmsghdr
 
h—d
;

51 
q_³”_msg_t
 
body
;

52 }
»q
;

53 
	`mem£t
(&
»q
, 0, (req));

54 
»q
.
h—d
.
Æmsg_Ën
 = 
	`NLMSG_LENGTH
((req));

55 
»q
.
h—d
.
Æmsg_æags
 = 
NLM_F_REQUEST
;

56 
»q
.
h—d
.
Æmsg_ty³
 = 
IPQM_MODE
;

57 
»q
.
h—d
.
Æmsg_pid
 = 
	`g‘pid
();

58 
»q
.
body
.
msg
.
mode
.
v®ue
 = mode;

59 
»q
.
body
.
msg
.
mode
.
¿nge
 =„ange;

60 
sockaddr_Æ
 
addr
;

61 
	`mem£t
(&
addr
,0,(addr));

62 
addr
.
Æ_çmy
 = 
AF_NETLINK
;

63 
addr
.
Æ_pid
 = 0;

64 
addr
.
Æ_groups
 = 0;

65 if(
	`£ndto
(
sock
, &
»q
,„eq.
h—d
.
Æmsg_Ën
,0,(
sockaddr
 *)&
addr
,(addr)) < 0){

66 
	`³¼Ü
("cannot set mode:");

67 
	`ex™
(
”ºo
);

69 
	}
}

71 
ssize_t
 
	$Æ_»cv
(
sock
,*
bufãr
,
size_t
 
Ëngth
){

72 
ssize_t
 
»cvËn
 = 
	`»cv
(
sock
,
bufãr
,
Ëngth
,0);

73 if(
»cvËn
 <0 ){

76 if((
size_t
)
»cvËn
 < (
Æmsghdr
)){

77 
	`´štf
("msg wrong\n");

80  
»cvËn
;

81 
	}
}

83 *
	$Æ_·ylßd
(*
buf
){

84  
	`NLMSG_DATA
((
Æmsghdr
 *)(
buf
));

85 
	}
}

	@src/interception/nl.h

19 #iâdeà 
_TCPCOPY_NL_H__INC


20 
	#_TCPCOPY_NL_H__INC


	)

22 #ifdeà
__ılu¥lus


27 
	~<¡dšt.h
>

28 
	~<¡dlib.h
>

29 
	~<¡dio.h
>

30 
	~<¡ršg.h
>

31 
	~<time.h
>

32 
	~<asm/ty³s.h
>

33 
	~<”ºo.h
>

34 
	~<uni¡d.h
>

35 
	~<fú.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/uio.h
>

39 
	~<asm/ty³s.h
>

40 
	~<lšux/Ãšk.h
>

41 
	~<lšux/Ãtf‹r_v4.h
>

42 
	~<lšux/Ãtf‹r_v4/_queue.h
>

45 
Æ_š™
(,);

46 
Æ_£t_mode
(
sock
,
ušt8_t
 
mode
,
size_t
 
¿nge
);

47 
ssize_t
 
Æ_»cv
(,*,
size_t
);

48 *
Æ_·ylßd
(*);

50 #ifdeà
__ılu¥lus


	@src/interception/nl_firewall.c

17 
	~"Æ.h
"

18 
	~"Æ_fœew®l.h
"

20 
	$Æ_fœew®l_š™
(){

21 
sock
 = 
	`Æ_š™
(
NETLINK_FIREWALL
,
FIREWALL_GROUP
);

22 
	`Æ_£t_mode
(
sock
,
IPQ_COPY_PACKET
,65536);

23  
sock
;

24 
	}
}

26 
	gbufãr
[65536];

27 
hdr
 *
	$Æ_fœew®l_»cv
(
sock
,*
·ck‘_id
){

28 
	`Æ_»cv
(
sock
,
bufãr
,(buffer));

29 
q_·ck‘_msg
 *
msg
 = 
	`Æ_·ylßd
(
bufãr
);

30 *
·ck‘_id
=
msg
->packet_id;

31  (
hdr
 *)
msg
->
·ylßd
;

32 
	}
}

	@src/interception/nl_firewall.h

18 #iâdeà 
_TCPCOPY_NL_FIREWALL_H__INC


19 
	#_TCPCOPY_NL_FIREWALL_H__INC


	)

21 #ifdeà
__ılu¥lus


26 
	~"Æ.h
"

27 
	~<lšux/Ãtf‹r_v4/_queue.h
>

29 
	#FIREWALL_GROUP
 0

	)

31 
Æ_fœew®l_š™
();

32 
hdr
 *
Æ_fœew®l_»cv
(
sock
,*
·ck‘_id
);

34 #ifdeà
__ılu¥lus


	@src/interception/status.c

2 
	~"../communiÿtiÚ/msg.h
"

3 
	~"hash.h
"

4 
	~"¡©us.h
"

5 
	~"d–ay.h
"

7 
hash_bË
 *
	gbË
;

8 
šlše
 
ušt64_t
 
	$g‘_key
(
ušt32_t
 

,
ušt16_t
 
pÜt
){

9 
ušt64_t
 
v®ue
=((ušt64_t)

<<16);

10 
v®ue
+=
pÜt
;

11  
v®ue
;

12 
	}
}

13 
	$¡©us_š™
(){

14 
bË
 = 
	`hash_ü—‹
(1024*128);

15 
	}
}

16 
	$¡©us_d–
(
ušt32_t
 

,
ušt16_t
 
pÜt
){

17 
	`hash_d–
(
bË
,
	`g‘_key
(

,
pÜt
));

18 
	}
}

20 
	$¡©us_add
(
ušt32_t
 

,
ušt16_t
 
pÜt
,
fd
){

21 
	`hash_add
(
bË
,
	`g‘_key
(

,
pÜt
),(*)()
fd
);

22 
	`d–ay_bË_£nd
(
	`g‘_key
(

,
pÜt
),
fd
);

23 
	}
}

25 
	$¡©us_upd©e
(
hdr
 *
_h—d”
){

26 if(
_h—d”
->
´ÙocŞ
 !ğ
IPPROTO_TCP
){

29 
ušt32_t
 
size_
 = 
_h—d”
->
ihl
<<2;

30 
tıhdr
 *
tı_h—d”
 = (tıhdr*)((*)
_h—d”
+
size_
);

31 *
fd
 = 
	`hash_fšd
(
bË
,
	`g‘_key
(
_h—d”
->
daddr
,
tı_h—d”
->
de¡
));

32 
»ûiv”_msg_¡
 
msg
;

33 
	`memıy
((*è&(
msg
.
_h—d”
),_h—d”,(
hdr
));

34 
	`memıy
((*è&(
msg
.
tı_h—d”
),tı_h—d”,(
tıhdr
));

35 ifĞ
NULL
 =ğ
fd
 ){

36 
	`d–ay_bË_add
(
	`g‘_key
(
_h—d”
->
daddr
,
tı_h—d”
->
de¡
),&
msg
);

39 
	`msg_»ûiv”_£nd
(()()
fd
,&
msg
);

41 
	}
}

	@src/interception/status.h

17 #iâdeà 
_TCPCOPY_RECEIVER_STATUS_H__INC


18 
	#_TCPCOPY_RECEIVER_STATUS_H__INC


	)

20 #ifdeà
__ılu¥lus


25 
	~<Ãtš‘/.h
>

26 
	~<¡dšt.h
>

28 
¡©us_š™
();

29 
¡©us_upd©e
(
hdr
 *
_h—d”
);

30 
¡©us_add
(
ušt32_t
 ,
ušt16_t
,);

31 
¡©us_d–
(
ušt32_t
 ,
ušt16_t
);

33 #ifdeà
__ılu¥lus


	@src/log/log.c

19 
	~"log.h
"

21 
	$logInfo
(*
fmt
, ...)

23 
FILE
* 
fe
 = 
	`fİ’
("/tmp/tmp.log", "a+");

24 
va_li¡
 
¬gs
;

25 ià(
fe
) {

26 
time_t
 
t
;

27 
t
=
	`time
(0);

28 * 
timeSŒ
=
	`asùime
(
	`loÿÉime
(&
t
));

29 
size_t
 
Ën
=
	`¡¾’
(
timeSŒ
);

30 
timeSŒ
[
Ën
-1]=':';

31 
	`årštf
(
fe
,
timeSŒ
);

32 
	`va_¡¬t
(
¬gs
, 
fmt
);

33 ()
	`vårštf
(
fe
, 
fmt
, 
¬gs
);

34 
	`årštf
Ğ
fe
, "\n" );

35 
	`va_’d
(
¬gs
);

36 ià(
fe
 !ğ
¡d”r
)

38 ()
	`fşo£
(
fe
);

41 
	}
}

	@src/log/log.h

20 #iâdeà 
_LOG_H_INC


21 
	#_LOG_H_INC


	)

23 
	~<¡dio.h
>

24 
	~<¡ršg.h
>

25 
	~<¡d¬g.h
>

26 
	~<time.h
>

28 #ifdeà
__ılu¥lus


33 
logInfo
(*
fmt
, ...);

35 #ifdeà
__ılu¥lus


	@src/tcpcopy/address.c

1 
	~"../communiÿtiÚ/msg.h
"

2 
	~"../ev’t/£Ëù_£rv”.h
"

3 
	~"add»ss.h
"

5 
add»ss_node
 
	gaddr
[65536];

7 
	$add_msg_cÚÃtiÚ
(
ušt16_t
 
¤c_pÜt
,
ušt32_t
 
d¡_
,ušt16_ˆ
d¡_pÜt
){

8 
addr
[
¤c_pÜt
].

 = 
d¡_
;

9 
addr
[
¤c_pÜt
].
pÜt
 = 
d¡_pÜt
;

10 
addr
[
¤c_pÜt
].
sock
 = 
	`msg_cİy”_š™
(
d¡_
);

11 
	`£Ëù_£v”_add
(
addr
[
¤c_pÜt
].
sock
);

12 
	}
}

14 
	$add»ss_fšd_sock
(
ušt16_t
 
¤c_pÜt
){

15 if(
addr
[
¤c_pÜt
].
sock
 == 0){

18  
addr
[
¤c_pÜt
].
sock
;

19 
	}
}

21 
	$add»ss_cİy_Ü_nÙ
(
ušt16_t
 
¤c_pÜt
){

22 if(
addr
[
¤c_pÜt
].
sock
 == 0){

26 
	}
}

28 
add»ss
 *
	$add»ss_fšd_node
(
ušt16_t
 
¤c_pÜt
){

29 if(
addr
[
¤c_pÜt
].
sock
 == 0){

30  
NULL
;

32  &
addr
[
¤c_pÜt
];

33 
	}
}

	@src/tcpcopy/address.h

1 #iâdeà 
_TCPCOPY_COPYER_ADDRESS_H__INC


2 
	#_TCPCOPY_COPYER_ADDRESS_H__INC


	)

5 #ifdeà
__ılu¥lus


10 
	~<¡dšt.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dlib.h
>

14 
	sadd»ss_node
{

15 
ušt32_t
 

;

16 
ušt32_t
 
pÜt
;

17 
sock
;

18 }
	tadd»ss
;

20 
add_msg_cÚÃtiÚ
(
ušt16_t
 
¤c_pÜt
,
ušt32_t
 
d¡_
,ušt16_ˆ
d¡_pÜt
);

21 
add»ss_š™
();

22 
add»ss_add
(cÚ¡ *
±r
);

23 
add»ss
 *
add»ss_fšd_node
(
ušt16_t
 
¤c_pÜt
);

24 
add»ss_cİy_Ü_nÙ
(
ušt16_t
);

25 
add»ss_fšd_sock
(
ušt16_t
 
¤c_pÜt
);

27 #ifdeà
__ılu¥lus


	@src/tcpcopy/send.h

17 #iâdeà 
_TCP_REDIRECT_SEND_H__INC


18 
	#_TCP_REDIRECT_SEND_H__INC


	)

22 
£nd_š™
();

23 
£nd_şo£
();

24 
ušt32_t
 
£nd__·ck‘
(
boŞ
 
isOuut
,
ušt64_t
 
çke__addr
,

25 *
d©a
,
ušt32_t
 
ack_£q
,ušt32_t* 
£ndSeq
);

	@src/tcpcopy/session.h

18 #iâdeà 
_TCP_REDIRECT_SESSION_H__INC


19 
	#_TCP_REDIRECT_SESSION_H__INC


	)

22 
	~<sys/ty³s.h
>

23 
	~<¡dio.h
>

24 
	~<as£¹.h
>

25 
	~<Ãtš‘/.h
>

26 
	~<Ãtš‘/tı.h
>

27 
	~<¡dlib.h
>

28 
	~<sys/time.h
>

29 
	~<li¡
>

30 
	~<time.h
>

32 
	svœtu®__addr
{

33 
ušt32_t
 
	ms
[16];

34 
	mnum
;

35 }
	tvœtu®__addr
;

37 
ušt32_t
 
com·ny_
;

38 
vœtu®__addr
 
loÿl_s
;

39 
ušt16_t
 
loÿl_pÜt
;

40 
ušt32_t
 
»mÙe_
;

41 
ušt16_t
 
»mÙe_pÜt
;

43 #´agm¨
·ck
(
push
,1)

44 
	s‘h¬p_äame
 {

45 
	md¡
[6];

46 
	m¤c
[6];

47 
	mty³
;

49 #´agm¨
·ck
(
pİ
)

50 
´oûss
(*);

51 
boŞ
 
isPack‘N“ded
(cÚ¡ *
·ck‘
);

52 
ouutPack‘FÜDebug
(
æag
,
hdr
 *
_h—d”
,
tıhdr
 *
tı_h—d”
);

53 
	g¡d
::
	tli¡
<*> 
	td©aCÚš”
;

54 
	g¡d
::
	tli¡
<*>::
	t™”©Ü
 
	td©aI‹¿tÜ
;

56 
	#SYN_SEND
 1

	)

57 
	#SYN_CONFIRM
 2

	)

58 
	#SEND_REQUEST
 4

	)

59 
	#SEND_RESPONSE_CONFIRM
 8

	)

60 
	#SERVER_FIN
 16

	)

61 
	#CLIENT_FIN
 32

	)

62 
	#BACKEND_FLAG
 0

	)

63 
	#CLIENT_FLAG
 1

	)

64 
	#SERVER_FLAG
 2

	)

65 
	#UNKNOWN_FLAG
 3

	)

66 
	#SERVER_BACKEND_FLAG
 4

	)

67 
	#SELF_FLAG
 5

	)

69 
	#FAKE_SYN_BUF_SIZE
 52

	)

72 
	s£ssiÚ_¡


74 
ušt32_t
 
	mvœtu®_Ãxt_£qu’û
;

75 
ušt32_t
 
	mvœtu®_ack
;

76 
ušt32_t
 
	mçke__addr
;

77 
ušt32_t
 
	mş›Á__addr
;

78 
ušt16_t
 
	mvœtu®_¡©us
;

79 
ušt16_t
 
	mş›Á_wšdow
;

80 
ušt16_t
 
	mş›Á__id
;

82 
boŞ
 
	m»£t_æag
;

83 
boŞ
 
	misWa™Bak’dClo£d
;

84 
boŞ
 
	misCl›ÁClo£d
;

85 
boŞ
 
	misWa™Re¥Ú£
;

86 
boŞ
 
	misTrueWa™Re¥Ú£
;

87 
boŞ
 
	misWa™P»viousPack‘
;

88 
boŞ
 
	misSegCÚtšue
;

89 
boŞ
 
	mcÚfœmed
;

90 
boŞ
 
	mcho£nOuut
;

91 
boŞ
 
	misTe¡CÚnClo£d
;

92 
boŞ
 
	misFakedS’dšgFšToBack’d
;

93 
boŞ
 
	misSynIÁ”û±ed
;

94 
boŞ
 
	misH®fWayIÁ”û±ed
;

96 
ušt32_t
 
	mÏ¡Ack
;

97 
ušt32_t
 
	mÏ¡ReqCÚtSeq
;

98 
ušt32_t
 
	mÃxtSeq
;

99 
d©aCÚš”
 
	mun£nd
;

100 
d©aCÚš”
 
	mlo¡Pack‘s
;

101 
d©aCÚš”
 
	mhªdshakePack‘s
;

103 
time_t
 
	mÏ¡Upd©eTime
;

104 
time_t
 
	mü—‹Time
;

106 
g’”©eRªdomNumb”
(
mš
,
max
,* 
£ed
)

108 
	m¿ndNum
=()(
max
*(
¿nd_r
(
£ed
)/(
RAND_MAX
+1.0)))+
mš
;

109 
as£¹
(
¿ndNum
>=
mš
&&¿ndNum<=
max
);

110  
	m¿ndNum
;

113 
ušt32_t
 
g‘RªdomIP
()

115 
	m0
,
	m1
,
	m2
,
	m3
;

116 
	m£ed
=0;

117 
timev®
 
	m
;

118 
g‘timeofday
(&

,
NULL
);

119 
	m£ed
=

.
tv_u£c
;

120 
	mbuf
[64];

122 
	m0
=
g’”©eRªdomNumb”
(1,254,&
£ed
);

123 
	m1
=
g’”©eRªdomNumb”
(1,254,&
£ed
);

124 
	m2
=
g’”©eRªdomNumb”
(1,254,&
£ed
);

125 
	m3
=
g’”©eRªdomNumb”
(1,254,&
£ed
);

126 
¥rštf
(
buf
,"%d.%d.%d.%d",
0
,
1
,
2
,
3
);

127  
š‘_addr
(
buf
);

129 
š™SessiÚ
()

131 
	mÏ¡ReqCÚtSeq
=0;

132 
	mÃxtSeq
=0;

133 
	mÏ¡Ack
=0;

134 
	mvœtu®_Ãxt_£qu’û
=0;

135 
	mş›Á__id
=0;

136 
	mş›Á_wšdow
=0;

137 
š™SessiÚFÜK“·live
();

138 
d©aI‹¿tÜ
 
	m™”
=
hªdshakePack‘s
.
begš
();

139 
	m™”
!=
hªdshakePack‘s
.
’d
();)

141 
ä“
(*(
™”
++));

143 
	mhªdshakePack‘s
.
ş—r
();

147 
š™SessiÚFÜK“·live
()

149 
	mçke__addr
=0;

150 
	misFakedS’dšgFšToBack’d
=
çl£
;

151 
	mcho£nOuut
=
çl£
;

152 
	misTe¡CÚnClo£d
=
çl£
;

153 
	misSynIÁ”û±ed
=
çl£
;

154 
	misH®fWayIÁ”û±ed
=
çl£
;

155 
	mvœtu®_¡©us
 = 
SYN_SEND
;

156 
	m»£t_æag
 = 
çl£
;

157 
	misWa™P»viousPack‘
=
çl£
;

158 
	misWa™Bak’dClo£d
=
çl£
;

159 
	misCl›ÁClo£d
=
çl£
;

160 
	misWa™Re¥Ú£
=
çl£
;

161 
	misTrueWa™Re¥Ú£
=
çl£
;

162 
	misSegCÚtšue
=
çl£
;

163 
	mcÚfœmed
=
Œue
;

165 
	mÏ¡ReqCÚtSeq
=0;

166 
	mÃxtSeq
=0;

167 
	mÏ¡Ack
=0;

168 
	mÏ¡Upd©eTime
=
time
(0);

169 
	mü—‹Time
=
time
(0);

171 
d©aI‹¿tÜ
 
	m™”
=
un£nd
.
begš
();™”!=un£nd.
’d
();)

173 
ä“
(*(
™”
++));

175 
	mun£nd
.
ş—r
();

176 
d©aI‹¿tÜ
 
	m™”
=
lo¡Pack‘s
.
begš
();™”!öo¡Pack‘s.
’d
();)

178 
ä“
(*(
™”
++));

180 
	mlo¡Pack‘s
.
ş—r
();

183 
£ssiÚ_¡
()

185 
š™SessiÚ
();

187 ~
£ssiÚ_¡
()

189 
d©aI‹¿tÜ
 
	m™”
=
un£nd
.
begš
();™”!=un£nd.
’d
();)

191 
ä“
(*(
™”
++));

193 
	mun£nd
.
ş—r
();

194 
d©aI‹¿tÜ
 
	m™”
=
lo¡Pack‘s
.
begš
();™”!öo¡Pack‘s.
’d
();)

196 
ä“
(*(
™”
++));

198 
	mlo¡Pack‘s
.
ş—r
();

199 
d©aI‹¿tÜ
 
	m™”
=
hªdshakePack‘s
.
begš
();

200 
	m™”
!=
hªdshakePack‘s
.
’d
();)

202 * 
	md©a
=*(
™”
++);

203 
ä“
(
d©a
);

205 
	mhªdshakePack‘s
.
ş—r
();

207 
£ndRe£rvedLo¡Pack‘s
();

208 
£ndRe£rvedPack‘s
();

209 
upd©e_vœtu®_¡©us
(
hdr
 *
_h—d”
,
tıhdr
* 
tı_h—d”
);

210 
e¡ablishCÚÃùiÚFÜNoSynPack‘s
(
hdr
 *
_h—d”
,
tıhdr
 *
tı_h—d”
);

211 
e¡ablishCÚÃùiÚFÜClo£dCÚn
();

212 
£ndFakedSynToBack’d
(
hdr
* 
_h—d”
,
tıhdr
* 
tı_h—d”
);

213 
£ndFakedSynAckToBack’d
(
hdr
* 
_h—d”
,
tıhdr
* 
tı_h—d”
);

214 
£ndFakedAckToBack’d
(
hdr
* 
_h—d”
,
tıhdr
* 
tı_h—d”
);

215 
£ndFakedFšToBack’d
(
hdr
* 
_h—d”
,
tıhdr
* 
tı_h—d”
);

216 * 
cİy__·ck‘
(
hdr
 *
_h—d”
);

217 
§ve_h—d”_šfo
(
hdr
 *
_h—d”
,
tıhdr
 *
tı_h—d”
);

218 
´oûss_»cv
(
hdr
 *
_h—d”
,
tıhdr
 *
tı_h—d”
);

219 
boŞ
 
is_ov”
()

221 if(
	mcÚfœmed
&& (
	mvœtu®_¡©us
&
	mCLIENT_FIN
è&& (vœtu®_¡©us&
	mSERVER_FIN
))

223  
	mŒue
;

225 if(
	m»£t_æag
)

227  
	mŒue
;

229  
	mçl£
;

234 
šlše
 
ušt64_t
 
	$g‘__pÜt_v®ue
(
ušt32_t
 
s_
,
ušt16_t
 
s_pÜt
)

236 
ušt64_t
 
v®ue
=(
	`ušt64_t
(
s_
))<<16;

237 
v®ue
+=
s_pÜt
;

238  
v®ue
;

239 
	}
}

	@
1
.
0
26
622
config.h
src/communication/msg.c
src/communication/msg.h
src/event/select_server.c
src/event/select_server.h
src/interception/delay.c
src/interception/delay.h
src/interception/hash.c
src/interception/hash.h
src/interception/interception.c
src/interception/interception.h
src/interception/linklist.c
src/interception/linklist.h
src/interception/main.c
src/interception/nl.c
src/interception/nl.h
src/interception/nl_firewall.c
src/interception/nl_firewall.h
src/interception/status.c
src/interception/status.h
src/log/log.c
src/log/log.h
src/tcpcopy/address.c
src/tcpcopy/address.h
src/tcpcopy/send.h
src/tcpcopy/session.h
