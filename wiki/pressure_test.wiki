#labels tcpcopy,pressure,test,stress
{{{
一、2台机器压力测试
13，14是在线应用服务器，148是测试服务器（148配置和13差不多）
我们的目的就是为了确认目前在线服务器能否承受目前两倍的压力，
测试结果如下：

13 cpu:
11124 adrun 15 0 193m 146m 744 S 18.6 7.3 495:31.56 asyn_server
11281 root 15 0 65144 40m 1076 S 12.3 2.0 0:47.89 tcpcopy

14 cpu:
16855 adrun 15 0 98.7m 55m 744 S 21.6 2.7 487:49.51 asyn_server
16429 root 15 0 41156 17m 1076 S 14.0 0.9 0:33.63 tcpcopy

148 cpu :
25609 root 15 0 76892 59m 764 S 49.6 2.9 63:03.14 asyn_server
20184 root 15 0 5624 4232 292 S 17.0 0.2 0:52.82 interception

13记录: grep 'Tue 11:08' access_0913_11.log |wc -l :89316

14记录: grep 'Tue 11:08' access_0913_11.log |wc -l :89309

148记录: grep 'Tue 11:08' access_0913_11.log |wc -l :178175

丢失率为：(89316+89309-178175)/(89316+89309)=0.25%

从上面可以看出一台在线服务器能够承受目前压力的两倍。


二、4台机器压力测试举例
在12，13，14，15 在线服务器部署tcpcopy client，集中向148测试
148机器：
20663 root      15   0 39080  25m  764 S 90.9  1.3 108:12.37 asyn_server  
22727 root      15   0  5756 4348  288 S 29.3  0.2  12:52.36 interception 

12机器：
2396 adrun       15   0  119m  75m  736 S 22.0  3.7 378:35.27 asyn_server
2083 root        15   0 57496  33m 1080 R 11.6  1.7   4:21.76 tcpcopy 

13机器：
11124 adrun     15   0  200m 153m  744 S 18.0  7.6 632:48.91 asyn_server 
30622 root      15   0 46496  22m 1076 S 12.0  1.1   6:29.23 tcpcopy  

14机器：
16855 adrun    15   0 99.0m  55m  744 S 19.6  2.8 623:07.56 asyn_server
3255 root      15   0 54364  30m 1076 S 14.0  1.5   6:25.76 tcpcopy  	

15机器：
17818 adrun    15   0  112m  68m  744 S 17.0  3.4 620:55.22 asyn_server
3793 root      15   0 78604  53m 1076 S 11.3  2.7   5:56.67 tcpcopy

[wangbin@bgp176-148 logs]$ grep 'Wed 10:36:' access_0914_10.log |wc -l  
310416
每秒平均处理5173.6，cpu消耗90%

[wangbin@bgp176-148 logs]$ netstat -n | awk '/^tcp/ {++state[$NF]} END {for(key in state) print key,"\t",state[key]}'
ESTABLISHED      282
TIME_WAIT        2179

[wangbin@bgp176-148 logs]$ grep 'Wed 10:3' access_0914_10.log |wc -l                                                 
3141729

[wangbin@bgp12-13 logs]$ grep 'Wed 10:3' access_0914_10.log |wc -l
807957
[wangbin@bgp12-14 logs]$ grep 'Wed 10:3' access_0914_10.log |wc -l
807954
[wangbin@bgp12-15 logs]$ grep 'Wed 10:3' access_0914_10.log |wc -l
807958
[wangbin@bgp12-12 logs]$ grep 'Wed 10:3' access_0914_10.log |wc -l
807943
实际请求数量=(807957+807954+807958+807943)=3231812
请求丢失率=(3231812-3141729)/3231812=2.79%

上面统计是程序未完善之前所进行的统计，可以看出由于压力增大，请求丢失率也会随着增大。
同时我们也可以看出，一台adserver可以支撑4台adserver的压力。

如果没有tcpcopy，我们是无法预知adserver到底能够承受多大的压力。

}}}