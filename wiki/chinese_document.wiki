#labels tcp,netlink,rawsockets,membase,memcached,onlinetesting
{{{

tcpcopy是请求复制工具，此工具非常具备实用性，我们曾经应用于网易的广告投放系统，避免了上线带来的很多问题。

测试举例： 
13，14是在线应用服务器，148是测试服务器（148配置和13差不多）
我们的目的就是为了确认目前在线服务器能否承受目前两倍的压力，
测试结果如下：

13 cpu:
11124 adrun 15 0 193m 146m 744 S 18.6 7.3 495:31.56 asyn_server 
11281 root 15 0 65144 40m 1076 S 12.3 2.0 0:47.89 tcpcopy

14 cpu: 
16855 adrun 15 0 98.7m 55m 744 S 21.6 2.7 487:49.51 asyn_server 
16429 root 15 0 41156 17m 1076 S 14.0 0.9 0:33.63 tcpcopy

148 cpu : 
25609 root 15 0 76892 59m 764 S 49.6 2.9 63:03.14 asyn_server 
20184 root 15 0 5624 4232 292 S 17.0 0.2 0:52.82 interception

13记录: grep 'Tue 11:08' access_0913_11.log |wc -l :89316

14记录: grep 'Tue 11:08' access_0913_11.log |wc -l :89309

148记录: grep 'Tue 11:08' access_0913_11.log |wc -l :178175

丢失率为：(89316+89309-178175)/(89316+89309)=0.25%

从上面可以看出一台在线服务器能够承受目前压力的两倍。


tcpcopy主要有三大功能：
1）分布式压力测试工具，利用在线数据，可以测试系统能够承受的压力大小，也可以提前发现一些bug
2）对于后端的短连接，请求丢失率非常低(1/10万)，可以应用于热备份
3）普通上线测试，可以发现新系统是否稳定，避免系统崩溃等问题


我们即将应用tcpcopy于membase替换现有mecached系统的任务中。由于membase还不够成熟，不适合直接上线，利用tcpcopy程序，可以把访问memcached的系统流量复制一份到membase系统中去。对于membase来说，这份流量就是访问membase的，跟直接上线membase效果一样，就可以做各种试验，查看membase的各种特性



}}}